<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Compiling Rust for a RISC-V with rv32e ISA</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Signika&display=swap" rel=stylesheet><style>body{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#3c4043;--text-pale-color:#9aa2b9;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f}body.dark{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#9197a5;--text-pale-color:#5d6470;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f}body{--main-font:'Signika',ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:70px;--paragraph-font-size:18px;--paragraph-line-height:1.75;--aside-font-size:16px;--img-border-radius:0;--inline-code-border-radius:2px}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header><div id=header-wrapper><nav><a href=/>grnmeira</a><span class=separator>/</span><a href=/posts>posts</a></nav><div id=btns><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Compiling Rust for a RISC-V with rv32e ISA</h1><div id=post-info><div id=date><span id=publish>2024-06-07</span></div></div><p>One of the interesting things that came out with Rust 1.78 is that now it ships with LLVM 18. I had a particular interest on that update, because <a rel="nofollow noreferrer" href=https://releases.llvm.org/18.1.0/docs/ReleaseNotes.html#changes-to-the-risc-v-backend>LLVM 18 supports the RISC-V's rv32e ISA</a>.<p>The rv32e is not a very special instruction set (it is for me though ❤️). If you're not familiar, RISC-V has an interesting uptake on modular ISAs. The rv32e is one of the most basic ones (the "e" stands for embedded), focusing on a reduced chip area footprint. It reduces the number of general use registers in half (compared to the other ISAs), and it has no float-point instructions, amongst other simplifications. To the day I'm writing this, the rv32e instruction set is still not signed off, but there's a few implementations already in production.<p>Before Rust 1.78, if you wanted to compile your crate for rv32e, you'd have to build your own Rust compiler with a <a rel="nofollow noreferrer" href=https://github.com/koute/rustc-rv32e>few patches</a>. But now, given LLVM 18 and the <a rel="nofollow noreferrer" href=https://doc.rust-lang.org/rustc/targets/custom.html>"custom target" feature</a>, that's not needed anymore.<p>I haven't written linker scripts in years, but let's give it a shot (using QEMU as our platform).<h1 id=creating-a-custom-target>Creating a Custom Target<a aria-label="Anchor link for: creating-a-custom-target" class=zola-anchor href=#creating-a-custom-target>#</a></h1><p>Even though LLVM 18 came out on Rust 1.78, we'll still need some unstable features in order to make this work (we'll have to compile the "core library" for our new target), so make sure you have your nightly toolchain installed and updated. Also, make sure you have a linker available in your system (on Ubuntu, the build-essentials package should help with that).<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustup install nightly</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustup update nightly</span>
</span></code></pre><p>Now, checking the custom targets our Rust compiler offers:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustc +nightly<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>print</span> target-list</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> riscv32</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32gc-unknown-linux-gnu</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32gc-unknown-linux-musl</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32i-unknown-none-elf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32im-risc0-zkvm-elf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32im-unknown-none-elf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imac-esp-espidf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imac-unknown-none-elf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imac-unknown-xous-elf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imafc-esp-espidf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imafc-unknown-none-elf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imc-esp-espidf</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32imc-unknown-none-elf</span></span>
</span></code></pre><p>We can print JSON descriptions for each of those. Let's try <code>riscv32i-unknown-none-elf</code>, that's rv32i, it's the closest to the bare metal rv32e we want. We'll save that specification into a file called <code>riscv32i-unknown-none-elf.json</code>.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustc +nightly<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Z</span> unstable-options<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32i-unknown-none-elf<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>print</span> target-spec-json</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tee</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> riscv32i-unknown-none-elf.json</span>
</span><span class="z-source z-shell z-bash"><span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>arch<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>riscv32<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>atomic-cas<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> false,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>cpu<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>generic-rv32<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>crt-objects-fallback<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>false<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>data-layout<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>e-m:e-p:32:32-i64:64-n32-S128<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>eh-frame-header<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> false,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>emit-debug-gdb-scripts<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> false,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>features<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>+forced-atomics<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>is-builtin<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> true,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>linker<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>rust-lld<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>linker-flavor<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>gnu-lld<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>llvm-target<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>riscv32<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>max-atomic-width<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 32,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>metadata<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>description<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>: null<span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>host_tools<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>: null<span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>std<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>: null<span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>tier<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>: null
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">  <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>panic-strategy<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>abort<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>relocation-model<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>static<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>,</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>target-pointer-width<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span>:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>32<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span></code></pre><p>There's a few things we'll change in that file, <code>features</code> will become <code>+forced-atomics,+e</code>, and we'll set <code>is-builtin</code> to <code>false</code>. And then we'll rename the file to <code>riscv32e-unknown-none-elf.json</code>.<h1 id=the-rust-code>The Rust Code<a aria-label="Anchor link for: the-rust-code" class=zola-anchor href=#the-rust-code>#</a></h1><p>For the Rust code, we'll start with a basic binary crate.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo new<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>bin</span> riscv32e-hello-world</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> mv riscv32e-unknown-none-elf.json riscv32e-hello-world/</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cd riscv32e-hello-world</span>
</span></code></pre><p>We'll do some small, but impactful, changes to <code>main.rs</code>:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#!</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_std</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#!</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_main</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_mangle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>C<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">entry</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">loop</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">panic_handler</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">panic</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">info</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>PanicInfo</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> </span></span><span class="z-keyword z-operator z-logical z-rust">!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>If you're not used to embedded/bare-metal Rust, this piece of code may look a bit weird. If you're not used to embedded at all, it's even weirder. But let's clarify why the structure of this program looks so different from ordinary Rust code you see around.<ul><li><code>#![no_std]</code>: this is necessary for "bare-metal programming". This tells Rust not to add the standard library to our crate. The standard library requires supports of an OS, which we don't have in this context, besides, it also adds runtime behaviour that we don't need or won't make any sense in our case.<li><code>#![no_main]</code>: this tells Rust we'll not use the conventional entry point function <code>main</code>. <code>main</code> expects runtime support, and again, we don't have this here. We want to start execution straight into our code!<li>The <code>entry</code> function: note that the entry function is using the <code>extern "C"</code> notation, as Rust doesn't have a stable ABI at the moment, it's common to enforce a C ABI in cases like this. Regarding the name of this function, it's arbitrary. The compiler or linker won't treat the <code>entry</code> symbol as a special case. Later, we'll find a way to tell the linker or the loader, that that's the entry point of our code. And its implementation is trivial, just an infinite loop.<li><code>#![panic_handler]</code>: this annotation allows us to specify how panics will be handle by the system. As we don't have <code>std</code> and no operating system is providing us default/error output facilities, Rust enforces the use of this handler. Our implementation in this example is just an infinite loop.</ul><h1 id=building>Building<a aria-label="Anchor link for: building" class=zola-anchor href=#building>#</a></h1><p>If we try to build the above code:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-language z-shell">$</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo +nightly build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32e-unknown-none-elf.json</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> riscv32e-hello-world v0.1.0 (/home/grnmeira/riscv32e-hello-world</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error[E0463]:</span></span><span class="z-meta z-function-call z-arguments z-shell"> can<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>t find crate for `core`
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">  |
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">  = note: the `riscv32e-unknown-none-elf` target may not be installed
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">  = help: consider downloading the target with `rustup target add riscv32e-unknown-none-elf`
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">  = help: consider building the standard library from source with `cargo build -Zbuild-std`
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">For more information about this error, try `rustc --explain E0463`.
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-string z-quoted z-single z-shell">error: could not compile `riscv32e-hello-world` (bin "riscv32e-hello-world") due to 1 previous error
</span></span></span></code></pre><p>And the reason is we don't have the <a rel="nofollow noreferrer" href=https://doc.rust-lang.org/stable/core/index.html><code>core</code> crate</a> available for our custom target, and that makes sense, it's a custom target after all. But there's good news too, we can compile our own <code>core</code> crate for our custom target, and that's pretty simple to do. Let's use the unstable option <code>build-std</code> as suggested by the error message.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-language z-shell">$</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo +nightly build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32e-unknown-none-elf.json<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Z</span> build-std</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/Cargo.lock<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> does not exist, unable to build with the standard library, try:</span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rustup</span></span><span class="z-meta z-function-call z-arguments z-shell"> component add rust-src<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>toolchain</span> nightly-x86_64-unknown-linux-gnu</span>
</span></code></pre><p>As if the borrow checker was not enough... But if we look into the error message again, what rustc is basically suggesting is that we install the standard library source code along our current Rust environment, so <a rel="nofollow noreferrer" href=https://rust-lang.github.io/rustup/concepts/components.html>that's what we're missing for <code>build-std</code></a>.<p>You may find it kind of awkward that we're installing the source code for a "x86_64-unknown-linux-gnu" toolchain, but in fact rustc is a cross-compiler by default, we're just tinkering with the final product generated by the compiler passing some custom options in the JSON file we've created.<p>Enough with the talk.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustup component add rust-src<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>toolchain</span> nightly-x86_64-unknown-linux-gnu</span>
</span></code></pre><p>And after trying to compile again, more errors...<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo +nightly build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32e-unknown-none-elf.json<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Z</span> build-std</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> compiler_builtins v0.1.109</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> core v0.0.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> libc v0.2.153</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> memchr v2.5.0</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> std v0.0.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> could not compile <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gimli</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> (lib</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">due</span></span><span class="z-meta z-function-call z-arguments z-shell"> to 4 previous errors</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">warning:</span></span><span class="z-meta z-function-call z-arguments z-shell"> build failed, waiting for other jobs to finish...</span>
</span></code></pre><p>Though if you look at what's going on, we're compiling <code>std</code>, and that's not supported to our custom target, we're even using <code>#![no_std]</code> in our code, that doesn't make sense. The thing is, we can make the <code>build-std</code> option more restrictive, and try to compile only the <code>core</code> library.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo +nightly build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32e-unknown-none-elf.json<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Z</span> build-std=core</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> core v0.0.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> compiler_builtins v0.1.109</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustc-std-workspace-core v1.99.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/rustc-std-workspace-core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> riscv32e-hello-world v0.1.0 (/home/grnmeira/riscv32e-hello-world</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> linking with <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rust-lld</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> failed: exit status: 1</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash">  <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">note:</span></span><span class="z-meta z-function-call z-arguments z-shell"> rust-lld: error: /home/grnmeira/riscv32e-hello-world/target/riscv32e-unknown-none-elf/debug/deps/riscv32e_hello_world-987885996197ed8d.4ctua6xahg0dlnvbrkwlw0qn4.rcgu.o: cannot link object files with different EF_RISCV_RVE</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> could not compile <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">riscv32e-hello-world</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> (bin <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>riscv32e-hello-world<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">due</span></span><span class="z-meta z-function-call z-arguments z-shell"> to 1 previous error</span>
</span></code></pre><p>Oof, this is a long error, I've even stripped out some parts to make it a bit clearer. <a rel="nofollow noreferrer" href=https://github.com/rust-lang/rust/issues/125052>Initially I thought this was some sort of bug</a> in <code>rustc</code>, as it seemed that the linker was trying to put together a binary using an <code>stdlib</code> that was not compatible with our rv32e ELF. After checking the compiler's code (using the diff of a previous patch supporting rv32e), it made sense it was just a memory layout issue. Long story short: we need to tell LLVM that we align the stack at 32 bits (instead of 128 originally for rv32i). And the reason for that is because we use the "ilp32e" ABI, and we also need to tell that to LLVM. So we'll change our target JSON once again:<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json">...
</span><span class="z-source z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>data-layout<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>: <span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>e-m:e-p:32:32-i64:64-n32-S32<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>,
</span><span class="z-source z-json">...
</span><span class="z-source z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>llvm-abiname<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>: <span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>ilp32e<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>
</span></code></pre><p>Note that the <code>llvm-abiname</code> attribute wasn't there before. If you want more (boring) details about this ABI, an easy internet search will get you the RISC-V official documents. Now let's run the compilation again:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo +nightly build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32e-unknown-none-elf.json<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Z</span> build-std=core</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> core v0.0.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> compiler_builtins v0.1.109</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustc-std-workspace-core v1.99.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/rustc-std-workspace-core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> riscv32e-hello-world v0.1.0 (/home/grnmeira/riscv32e-hello-world</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dev</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> profile <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 5.95s</span>
</span></code></pre><p>Awesome, that's looking much better. Let's check our output file. In order to do that we'll use LLVM's binutils.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo install cargo-binutils</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustup component add llvm-tools</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rust-objdump<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>hdf</span> target/riscv32e-unknown-none-elf/debug/riscv32e-hello-world</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">target/riscv32e-unknown-none-elf/debug/riscv32e-hello-world:</span></span><span class="z-meta z-function-call z-arguments z-shell">    file format elf32-littleriscv</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">architecture:</span></span><span class="z-meta z-function-call z-arguments z-shell"> riscv32</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">start</span></span><span class="z-meta z-function-call z-arguments z-shell"> address: 0x00000000</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Sections:</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Idx</span></span><span class="z-meta z-function-call z-arguments z-shell"> Name              Size     VMA      Type</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell">                   00000000 00000000</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_abbrev     00000132 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_info       0000063f 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">3</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_aranges    00000028 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">4</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_ranges     00000018 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">5</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_str        000004de 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">6</span></span><span class="z-meta z-function-call z-arguments z-shell"> .comment          00000048 00000000</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7</span></span><span class="z-meta z-function-call z-arguments z-shell"> .riscv.attributes 0000001c 00000000</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">8</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_frame      00000038 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">9</span></span><span class="z-meta z-function-call z-arguments z-shell"> .debug_line       00000057 00000000 DEBUG</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">10</span></span><span class="z-meta z-function-call z-arguments z-shell"> .symtab           00000690 00000000</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">11</span></span><span class="z-meta z-function-call z-arguments z-shell"> .shstrtab         00000091 00000000</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">12</span></span><span class="z-meta z-function-call z-arguments z-shell"> .strtab           0000005d 00000000</span>
</span></code></pre><p>That doesn't look good, it's like our file has no (or an empty) text sessions. ELF files are supposed to contain code sections, which are basically data or text (code to be executed) and how to load those into memory. Also, it tells where the execution should begin from. There's nothing like that in our output. We'll get that fixed.<h1 id=linker-script>Linker Script<a aria-label="Anchor link for: linker-script" class=zola-anchor href=#linker-script>#</a></h1><p>Linkers tend to be very aggressive when optimizing for dead code. As the linker doesn't know a starting point in our code, it assumes none of the functions we've implemented are reachable. We'll write a linker script and tell the linker where to start. So in our crate root directory we'll create a <code>link.ld</code> file with the following content:<pre class=z-code><code><span class="z-text z-plain">ENTRY(entry)
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">SECTIONS {
</span><span class="z-text z-plain">  . = 0x80000000;
</span><span class="z-text z-plain">  .text : { *(.text); *(.text.*) }
</span><span class="z-text z-plain">}
</span></code></pre><p>This is a quite minimal linker script. It tells the linker to use our <code>entry</code> function as starting point. And we also create a <code>.text</code> section in the resulting ELF, and it'll place all our program's executable code in there, signaling that that section should be loaded at memory address <code>0x80000000</code>.<p>There's a few ways we can tell cargo to pass that script as an input to the linker. The tidy one would probably use a <code>build.rs</code> script. But let's avoid that complexity for now using a workaround to keep things in a single command line. We'll override the <code>build.rustargs</code> Cargo configuration. That configuration passes extra arguments to <code>rustc</code> on every compiler call.<p>More specifically, we'll pass <code>-Clink-arg=-Tlink.ld</code>, which will, in turn, pass <code>-Tlink.ld</code> to the linker. Note that this is very platform independent, as Rust may use different flavors of linkers.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo +nightly<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>config</span> build.rustflags=<span class="z-constant z-character z-escape z-shell">\"</span>-Clink-arg=-Tlink.ld<span class="z-constant z-character z-escape z-shell">\"</span> build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> riscv32e-unknown-none-elf.json<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>Z</span> build-std=core</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> core v0.0.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> compiler_builtins v0.1.109</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> rustc-std-workspace-core v1.99.0 (/home/grnmeira/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/rustc-std-workspace-core</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Compiling</span></span><span class="z-meta z-function-call z-arguments z-shell"> riscv32e-hello-world v0.1.0 (/home/grnmeira/riscv32e-hello-world</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dev</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> profile <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 8.83s</span>
</span></code></pre><p>That seemed successful. Checking now if that solves our problem with the final ELF:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> rust-objdump<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> target/riscv32e-unknown-none-elf/debug/riscv32e-hello-world</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">target/riscv32e-unknown-none-elf/debug/riscv32e-hello-world:</span></span><span class="z-meta z-function-call z-arguments z-shell">    file format elf32-littleriscv</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Disassembly</span></span><span class="z-meta z-function-call z-arguments z-shell"> of section .text:</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">80000000</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>entry<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>:</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">80000000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6f 00 40 00   j       0x80000004 <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>entry+0x4<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">80000004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 6f 00 00 00   j       0x80000004 <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>entry+0x4<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>
</span></span></code></pre><p>That's looking much better now. <code>entry</code> is there, at the right address. You can see the <code>j</code> instruction jumping to the same address in an infinite loop. Probably not the most smart piece of code you've ever written though.<h1 id=running-on-qemu>Running on QEMU<a aria-label="Anchor link for: running-on-qemu" class=zola-anchor href=#running-on-qemu>#</a></h1><p>Let's give it a shot with QEMU now. We'll install <code>qemu-system</code> and <code>gdb-multiarch</code>.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo apt update</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo apt install qemu-system gdb-multiarch</span>
</span></code></pre><p>In order to run our binary on QEMU, we do:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> qemu-system-riscv32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>S</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>cpu</span> rv32<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>machine</span> virt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>bios</span> none<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>nographic</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>device</span> loader,file=./target/riscv32e-unknown-none-elf/debug/riscv32e-hello-world.elf</span>
</span></code></pre><p>Some quick explanations of what's happening in the above.<ul><li><code>-s</code> tells QEMU to listen as a GDB server on TCP <code>localhost:1234</code>.<li><code>-S</code> tells QEMU to wait for commands from the debugger before the CPU starts (this way we can have total control from GDB).<li><code>-cpu rv32</code> should be quite obvious. Note though we don't specify a subset here (in our case "e").<li><code>-machine virt</code> is the most generic machine from QEMU.<li><code>-bios none</code> use no BIOS for booting, meaning we can't go more bare-metal than this. There's no initial code setting up modes, basic IO or whatever, we're alone by ourselves here.<li><code>-nographic</code> tells QEMU not to use their graphical interface.<li>Now my favourite: <code>-device loader</code>. It's the first time I use this device on QEMU (even though I used a lot of QEMU in the past, mainly for ARM), and I love it. It's able to load a couple of different formats in memory. But what I like the most is that it loads ELF binaries, which is just great in scenarios where you're exploring an architecture and you can just focus on your linker script. So all we need to do is to specify the output ELF from our compilation and it's done! Well, almost...</ul><p>As soon as you kick off that command, the emulated CPU will freeze, and we need GDB now to get things really running.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grnmeira@wsl-ubuntu-24.04:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>/riscv32e-hello-world$</span></span><span class="z-meta z-function-call z-arguments z-shell"> gdb-multiarch target/riscv32e-unknown-none-elf/debug/riscv32e-hello-world.elf<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>ex</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>target remote :1234<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">gdb</span></span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> info r pc</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pc</span></span><span class="z-meta z-function-call z-arguments z-shell">             0x1000   0x1000</span>
</span></code></pre><p>There we are, the beginning of everything, our rv32e core has the address 0x1000 loaded into its pc register. Even though we specify "no BIOS" for QEMU, there's a few instructions executed before it jumps to the actual address of <code>entry</code>.<pre class=z-code><code><span class="z-text z-plain">(gdb) disassemble 0x1000,0x101e
</span><span class="z-text z-plain">Dump of assembler code from 0x1000 to 0x1024:
</span><span class="z-text z-plain">=> 0x00001000:  auipc   t0,0x0
</span><span class="z-text z-plain">   0x00001004:  addi    a2,t0,40 # 0x1028
</span><span class="z-text z-plain">   0x00001008:  .insn   4, 0xf1402573
</span><span class="z-text z-plain">   0x0000100c:  lw      a1,32(t0)
</span><span class="z-text z-plain">   0x00001010:  lw      t0,24(t0)
</span><span class="z-text z-plain">   0x00001014:  jr      t0
</span><span class="z-text z-plain">   0x00001018:  .insn   2, 0x
</span><span class="z-text z-plain">   0x0000101a:  .insn   2, 0x8000
</span><span class="z-text z-plain">   0x0000101c:  .insn   2, 0x
</span><span class="z-text z-plain">End of assembler dump.
</span></code></pre><p>If we keep stepping over these initial instructions (<code>si</code> command), <em>voilà</em>... We jump into our <code>entry</code> function.<pre class=z-code><code><span class="z-text z-plain">...
</span><span class="z-text z-plain">(gdb) si
</span><span class="z-text z-plain">riscv32e_hello_world::entry () at src/main.rs:8
</span><span class="z-text z-plain">8           loop{}
</span><span class="z-text z-plain">(gdb)
</span></code></pre><p>Does it count as a "hello world"? probably not, but I believe this is a great start. There's a few caveats here if we want to do anything more complex than this. Fore example, we don't initialize the stack pointer, which means, if we do anything that produces a store operation to the stack, we're doomed (we'd be writing something to a, very likely, invalid memory address). Also, we created a very minimalist linker script, which basically strips out any data sections from our binary, meaning that, if any static data is needed, we would also get into trouble.<p>Putting together a more complete bare-metal program doesn't fit well with this post's format. Hopefully on an upcoming post, using everything done here as scaffolding, we could dig into more details on getting a proper Rust runtime running.</article><div class=giscus></div></div><footer><div class=copyright><p>© 2023 Gustavo R. N. Meira</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>